{% extends "base.html" %}
{% block page_title %}| OCR PDF Converter{% endblock %}
{% block page_breadcrumb %}PDF Tools / OCR{% endblock %}
{% block page_head_title %}OCR PDF Converter{% endblock %}

{% block page_stylesheet %}
<!-- DataTables -->
<link rel="stylesheet" href="{{ url_for('static', path='plugins/datatables-bs4/css/dataTables.bootstrap4.css') }}">
<!-- SweetAlert2 -->
<link rel="stylesheet" href="{{ url_for('static', path='plugins/sweetalert2-theme-bootstrap-4/bootstrap-4.min.css') }}">
<style>
.upload-zone {
    border: 2px dashed #007bff;
    border-radius: 10px;
    padding: 40px;
    text-align: center;
    background-color: #f8f9fa;
    transition: all 0.3s ease;
    cursor: pointer;
}
.upload-zone:hover {
    border-color: #0056b3;
    background-color: #e9ecef;
}
.upload-zone.dragover {
    border-color: #28a745;
    background-color: #d4edda;
}
.job-status {
    font-weight: bold;
}
.status-pending { color: #ffc107; }
.status-processing { color: #17a2b8; }
.status-completed { color: #28a745; }
.status-failed { color: #dc3545; }
.file-info {
    font-size: 0.9em;
    color: #6c757d;
}
.job-actions {
    white-space: nowrap;
}
.info-box-icon {
    display: flex;
    align-items: center;
    justify-content: center;
}
</style>
{% endblock %}

{% block body %}
<section class="content">
    <div class="container-fluid">
        
        {% if user_info.get("is_admin") %}
        <!-- Admin View: Metrics Section -->
        <div class="row">
          <div class="col-12">
            <h3>System Metrics</h3>
          </div>
        </div>
        
        <!-- Metrics Info Boxes -->
        <div class="row">
          <!-- Total Jobs -->
          <div class="col-lg-3 col-6">
            <div class="info-box bg-info">
              <span class="info-box-icon"><i class="fas fa-file-pdf"></i></span>
              <div class="info-box-content">
                <span class="info-box-text">Total OCR Jobs</span>
                <span class="info-box-number">{{ ocr_metrics.total_jobs or 0 }}</span>
              </div>
            </div>
          </div>
          
          <!-- Completed Jobs -->
          <div class="col-lg-3 col-6">
            <div class="info-box bg-success">
              <span class="info-box-icon"><i class="fas fa-check-circle"></i></span>
              <div class="info-box-content">
                <span class="info-box-text">Completed Jobs</span>
                <span class="info-box-number">{{ ocr_metrics.completed_jobs or 0 }}</span>
              </div>
            </div>
          </div>
          
          <!-- Failed Jobs -->
          <div class="col-lg-3 col-6">
            <div class="info-box bg-danger">
              <span class="info-box-icon"><i class="fas fa-times-circle"></i></span>
              <div class="info-box-content">
                <span class="info-box-text">Failed Jobs</span>
                <span class="info-box-number">{{ ocr_metrics.failed_jobs or 0 }}</span>
              </div>
            </div>
          </div>
          
          <!-- Processing Jobs -->
          <div class="col-lg-3 col-6">
            <div class="info-box bg-warning">
              <span class="info-box-icon"><i class="fas fa-cog fa-spin"></i></span>
              <div class="info-box-content">
                <span class="info-box-text">Processing Jobs</span>
                <span class="info-box-number">{{ ocr_metrics.processing_jobs or 0 }}</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Additional Metrics -->
        <div class="row">
          <!-- Unique Users -->
          <div class="col-lg-3 col-6">
            <div class="info-box bg-primary">
              <span class="info-box-icon"><i class="fas fa-users"></i></span>
              <div class="info-box-content">
                <span class="info-box-text">Unique Users</span>
                <span class="info-box-number">{{ ocr_metrics.unique_users or 0 }}</span>
              </div>
            </div>
          </div>
          
          <!-- Total Pages -->
          <div class="col-lg-3 col-6">
            <div class="info-box bg-secondary">
              <span class="info-box-icon"><i class="fas fa-file-alt"></i></span>
              <div class="info-box-content">
                <span class="info-box-text">Pages Processed</span>
                <span class="info-box-number">{{ ocr_metrics.total_pages or 0 }}</span>
              </div>
            </div>
          </div>
          
          <!-- Success Rate -->
          <div class="col-lg-3 col-6">
            <div class="info-box bg-teal">
              <span class="info-box-icon"><i class="fas fa-chart-line"></i></span>
              <div class="info-box-content">
                <span class="info-box-text">Success Rate</span>
                <span class="info-box-number">{{ ocr_metrics.success_rate or 0 }}%</span>
              </div>
            </div>
          </div>
          
          <!-- Space Savings -->
          <div class="col-lg-3 col-6">
            <div class="info-box bg-indigo">
              <span class="info-box-icon"><i class="fas fa-compress-alt"></i></span>
              <div class="info-box-content">
                <span class="info-box-text">Space Savings</span>
                <span class="info-box-number">{{ ocr_metrics.space_savings or 0 }}%</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Recent Jobs Table for Admin -->
        <div class="row">
          <div class="col-12">
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">Recent OCR Jobs</h3>
              </div>
              <div class="card-body">
                <div class="table-responsive">
                  <table class="table table-striped table-hover" id="admin-jobs-table">
                    <thead>
                      <tr>
                        <th>Job ID</th>
                        <th>User</th>
                        <th>Filename</th>
                        <th>Status</th>
                        <th>Pages</th>
                        <th>Processing Time</th>
                        <th>Created</th>
                        <th>Actions</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for job in recent_jobs %}
                      <tr>
                        <td><code>{{ job.job_id }}</code></td>
                        <td>{{ job.user_id }}</td>
                        <td>{{ job.original_filename }}</td>
                        <td>
                          {% if job.status == 'completed' %}
                            <span class="badge bg-success">Completed</span>
                          {% elif job.status == 'failed' %}
                            <span class="badge bg-danger">Failed</span>
                          {% elif job.status == 'processing' %}
                            <span class="badge bg-warning">Processing</span>
                          {% else %}
                            <span class="badge bg-secondary">{{ job.status }}</span>
                          {% endif %}
                        </td>
                        <td>{{ job.page_count or 0 }}</td>
                        <td>{{ "%.2f"|format(job.processing_time or 0) }}s</td>
                        <td>{{ job.date_created.strftime('%Y-%m-%d %H:%M') if job.date_created else '' }}</td>
                        <td>
                          {% if job.status == 'completed' %}
                            <a href="/ocr/download/{{ job.job_id }}" class="btn btn-sm btn-primary">
                              <i class="fas fa-download"></i> Download
                            </a>
                          {% endif %}
                        </td>
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
        {% endif %}
        
        <!-- Upload Section (Available to all users) -->
        <div class="row">
            <div class="col-12">
                <div class="card card-primary">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-upload"></i> Upload PDF for OCR Processing
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="upload-zone" id="upload-zone">
                            <i class="fas fa-cloud-upload-alt fa-3x mb-3"></i>
                            <h4>Drop PDF files here or click to browse</h4>
                            <p class="text-muted">Maximum file size: 50MB</p>
                            <button type="button" class="btn btn-outline-primary" id="browse-btn">
                                <i class="fas fa-folder-open"></i> Browse Files
                            </button>
                        </div>
                        
                        <input type="file" id="pdf-file-input" accept=".pdf" style="display: none;">
                        
                        <div id="upload-progress" class="mt-3" style="display: none;">
                            <div class="progress">
                                <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                     role="progressbar" style="width: 0%">
                                    <span class="sr-only">Uploading...</span>
                                </div>
                            </div>
                            <small class="text-muted">Processing your PDF...</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- User Jobs Section (for non-admin users) -->
        {% if not user_info.get("is_admin") %}
        <div class="row">
          <div class="col-12">
            <h3>Your OCR Jobs</h3>
          </div>
        </div>
        
        <!-- User Metrics -->
        <div class="row">
          <div class="col-lg-3 col-6">
            <div class="info-box bg-info">
              <span class="info-box-icon"><i class="fas fa-file"></i></span>
              <div class="info-box-content">
                <span class="info-box-text">Your Total Jobs</span>
                <span class="info-box-number">{{ user_summary.user_jobs or 0 }}</span>
              </div>
            </div>
          </div>
          
          <div class="col-lg-3 col-6">
            <div class="info-box bg-success">
              <span class="info-box-icon"><i class="fas fa-check"></i></span>
              <div class="info-box-content">
                <span class="info-box-text">Completed</span>
                <span class="info-box-number">{{ user_summary.user_completed_jobs or 0 }}</span>
              </div>
            </div>
          </div>
          
          <div class="col-lg-3 col-6">
            <div class="info-box bg-danger">
              <span class="info-box-icon"><i class="fas fa-times"></i></span>
              <div class="info-box-content">
                <span class="info-box-text">Failed</span>
                <span class="info-box-number">{{ user_summary.user_failed_jobs or 0 }}</span>
              </div>
            </div>
          </div>
          
          <div class="col-lg-3 col-6">
            <div class="info-box bg-primary">
              <span class="info-box-icon"><i class="fas fa-chart-pie"></i></span>
              <div class="info-box-content">
                <span class="info-box-text">Success Rate</span>
                <span class="info-box-number">{{ user_summary.user_success_rate or 0 }}%</span>
              </div>
            </div>
          </div>
        </div>
        {% endif %}

        <!-- Job Status Check Form (for all users) -->
        <div class="row">
          <div class="col-12">
            <div class="card card-secondary">
              <div class="card-header">
                <h3 class="card-title">
                  <i class="fas fa-search"></i> Check Job Status / Download
                </h3>
              </div>
              <div class="card-body">
                <form action="/ocr/status" method="post" id="statusCheckForm">
                  <div class="form-group">
                    <label for="jobId">Job ID</label>
                    <div class="input-group">
                      <input type="text" class="form-control" id="jobId" name="job_id" 
                             placeholder="Enter your OCR job ID" required>
                      <div class="input-group-append">
                        <button type="submit" class="btn btn-secondary">
                          <i class="fas fa-search"></i> Check Status
                        </button>
                      </div>
                    </div>
                    <small class="form-text text-muted">You received this ID when you uploaded your PDF</small>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>

        <!-- Jobs Table -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Your OCR Jobs</h3>
                        <div class="card-tools">
                            <button type="button" class="btn btn-sm btn-primary" id="refresh-jobs">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <table class="table table-striped table-hover" id="jobs-table">
                            <thead>
                                <tr>
                                    <th>Filename</th>
                                    <th>Status</th>
                                    <th>Created</th>
                                    <th>Size</th>
                                    <th>Duration</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Jobs will be loaded via AJAX -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Your Recent Jobs (for regular users) -->
        {% if not user_info.get("is_admin") and user_summary.user_recent_jobs %}
        <div class="row">
          <div class="col-12">
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">Your Recent Jobs</h3>
              </div>
              <div class="card-body">
                <div class="table-responsive">
                  <table class="table table-striped">
                    <thead>
                      <tr>
                        <th>Job ID</th>
                        <th>Filename</th>
                        <th>Status</th>
                        <th>Pages</th>
                        <th>Created</th>
                        <th>Actions</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for job in user_summary.user_recent_jobs %}
                      <tr>
                        <td><code>{{ job.job_id }}</code></td>
                        <td>{{ job.original_filename }}</td>
                        <td>
                          {% if job.status == 'completed' %}
                            <span class="badge bg-success">Completed</span>
                          {% elif job.status == 'failed' %}
                            <span class="badge bg-danger">Failed</span>
                          {% elif job.status == 'processing' %}
                            <span class="badge bg-warning">Processing</span>
                          {% else %}
                            <span class="badge bg-secondary">{{ job.status }}</span>
                          {% endif %}
                        </td>
                        <td>{{ job.page_count or 0 }}</td>
                        <td>{{ job.date_created.strftime('%Y-%m-%d %H:%M') if job.date_created else '' }}</td>
                        <td>
                          {% if job.status == 'completed' %}
                            <a href="/ocr/download/{{ job.job_id }}" class="btn btn-sm btn-primary">
                              <i class="fas fa-download"></i> Download
                            </a>
                          {% endif %}
                        </td>
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
        {% endif %}

    </div>
</section>
{% endblock %}

{% block page_javascript %}
<!-- DataTables -->
<script src="{{ url_for('static', path='plugins/datatables/jquery.dataTables.js') }}"></script>
<script src="{{ url_for('static', path='plugins/datatables-bs4/js/dataTables.bootstrap4.js') }}"></script>
<!-- SweetAlert2 -->
<script src="{{ url_for('static', path='plugins/sweetalert2/sweetalert2.min.js') }}"></script>

<script>
$(document).ready(function() {
    // Initialize DataTables
    const table = $('#jobs-table').DataTable({
        "responsive": true,
        "lengthChange": false,
        "autoWidth": false,
        "pageLength": 10,
        "order": [[2, "desc"]], // Sort by creation date descending
        "columnDefs": [
            { "orderable": false, "targets": 5 } // Actions column not orderable
        ]
    });

    // File upload handling
    const uploadZone = $('#upload-zone');
    const fileInput = $('#pdf-file-input');
    const browseBtn = $('#browse-btn');
    const uploadProgress = $('#upload-progress');

    // Click to browse
    browseBtn.click(function() {
        fileInput.click();
    });

    uploadZone.click(function() {
        fileInput.click();
    });

    // Drag and drop
    uploadZone.on('dragover', function(e) {
        e.preventDefault();
        $(this).addClass('dragover');
    });

    uploadZone.on('dragleave', function(e) {
        e.preventDefault();
        $(this).removeClass('dragover');
    });

    uploadZone.on('drop', function(e) {
        e.preventDefault();
        $(this).removeClass('dragover');
        
        const files = e.originalEvent.dataTransfer.files;
        if (files.length > 0) {
            handleFileUpload(files[0]);
        }
    });

    // File input change
    fileInput.change(function() {
        const file = this.files[0];
        if (file) {
            handleFileUpload(file);
        }
    });

    // Handle file upload
    function handleFileUpload(file) {
        // Validate file
        if (file.type !== 'application/pdf') {
            Swal.fire({
                icon: 'error',
                title: 'Invalid File',
                text: 'Please select a PDF file.'
            });
            return;
        }

        if (file.size > 50 * 1024 * 1024) { // 50MB
            Swal.fire({
                icon: 'error',
                title: 'File Too Large',
                text: 'File size exceeds 50MB limit.'
            });
            return;
        }

        // Show progress
        uploadProgress.show();
        $('.progress-bar').css('width', '10%');

        // Create form data
        const formData = new FormData();
        formData.append('pdf_file', file);

        // Upload file
        $.ajax({
            url: '/ocr/upload',
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            xhr: function() {
                const xhr = new window.XMLHttpRequest();
                xhr.upload.addEventListener('progress', function(evt) {
                    if (evt.lengthComputable) {
                        const percentComplete = (evt.loaded / evt.total) * 100;
                        $('.progress-bar').css('width', percentComplete + '%');
                    }
                }, false);
                return xhr;
            },
            success: function(response) {
                $('.progress-bar').css('width', '100%');
                setTimeout(function() {
                    uploadProgress.hide();
                    $('.progress-bar').css('width', '0%');
                }, 1000);
                
                Swal.fire({
                    icon: 'success',
                    title: 'Upload Successful!',
                    text: `Job ID: ${response.job_id}. Processing has started.`,
                    showConfirmButton: true
                });
                
                // Refresh jobs table
                refreshJobs();
            },
            error: function(xhr) {
                uploadProgress.hide();
                $('.progress-bar').css('width', '0%');
                
                let errorMessage = 'Upload failed. Please try again.';
                if (xhr.responseJSON && xhr.responseJSON.detail) {
                    errorMessage = xhr.responseJSON.detail;
                }
                
                Swal.fire({
                    icon: 'error',
                    title: 'Upload Failed',
                    text: errorMessage
                });
            }
        });
    }

    // Refresh jobs
    function refreshJobs() {
        $.get('/ocr/jobs')
            .done(function(response) {
                const tbody = $('#jobs-table tbody');
                tbody.empty();
                
                if (response.jobs && response.jobs.length > 0) {
                    response.jobs.forEach(function(job) {
                        let statusBadge = '';
                        let actionButton = '';
                        
                        switch (job.status) {
                            case 'completed':
                                statusBadge = '<span class="badge bg-success">Completed</span>';
                                if (job.download_available) {
                                    actionButton = `<a href="/ocr/download/${job.job_id}" class="btn btn-sm btn-success">
                                        <i class="fas fa-download"></i> Download
                                    </a>`;
                                }
                                break;
                            case 'processing':
                                statusBadge = '<span class="badge bg-warning">Processing</span>';
                                break;
                            case 'failed':
                                statusBadge = '<span class="badge bg-danger">Failed</span>';
                                break;
                            default:
                                statusBadge = `<span class="badge bg-secondary">${job.status}</span>`;
                        }
                        
                        const row = `
                        <tr>
                            <td>${job.original_filename}</td>
                            <td>${statusBadge}</td>
                            <td>${job.date_created || 'N/A'}</td>
                            <td>${job.file_size_original || 'N/A'}</td>
                            <td>${job.processing_duration || 'N/A'}</td>
                            <td class="job-actions">
                                ${actionButton}
                            </td>
                        </tr>
                        `;
                        tbody.append(row);
                    });
                } else {
                    tbody.append(`
                        <tr>
                            <td colspan="6" class="text-center text-muted">
                                No OCR jobs found. Upload a PDF to get started!
                            </td>
                        </tr>
                    `);
                }
                
                table.clear().rows.add(tbody.find('tr')).draw();
            })
            .fail(function() {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Failed to refresh jobs list.'
                });
            });
    }

    // Status check form handling  
    $('#statusCheckForm').on('submit', function(e) {
        let jobId = $('#jobId').val().trim();
        if (jobId.length === 0) {
            e.preventDefault();
            alert('Please enter a job ID');
            return;
        }
    });

    // Refresh button
    $('#refresh-jobs').click(function() {
        refreshJobs();
    });

    // Load jobs on page load
    refreshJobs();

    // Auto-refresh jobs every 30 seconds
    setInterval(refreshJobs, 30000);
});
</script>
{% endblock %}
