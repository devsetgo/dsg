version: "3.3"

services:
  devsetgoTest:
    image: mikeryan56/dsg:beta-2024-09-02-3
    env_file:
      - .env
    restart: always
    ports:
      - "5000"
    networks:
      - web
      - postgresql_db_network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.dsg-web-test.rule=Host(`test.devsetgo.com`)"
      - "traefik.http.routers.dsg-web-test.entrypoints=web"
      - "traefik.http.routers.dsg-web-test.middlewares=redirect@file"
      - "traefik.http.routers.dsg-test-secured.rule=Host(`test.devsetgo.com`)"
      - "traefik.http.routers.dsg-test-secured.entrypoints=web-secured"
      - "traefik.http.routers.dsg-test-secured.tls.certresolver=mytlschallenge"
    volumes:
      - shared-spacy-models:/shared/spacy_models
      - log-volume:/app/log
    deploy:
      replicas: 2
      update_config:
        parallelism: 1
        delay: 30s
      restart_policy:
        condition: on-failure
  
  # filebeat:
  #   image: docker.elastic.co/beats/filebeat:8.15.0
  #   user: root
  #   volumes:
  #     - /log:/log
  #     - ./filebeat.yml:/usr/share/filebeat/filebeat.yml
  #   networks:
  #     - elk
networks:
  web:
    external: true
  postgresql_db_network:
    external: true
  # elk:
  #   external: true

volumes:
  devsetgoTest:
    external: false
  shared-spacy-models:
    driver: local
  log-volume:
    driver: local
